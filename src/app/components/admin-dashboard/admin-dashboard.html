<!-- Toast Messages -->
<p-toast></p-toast>

<!-- Search Bar for Stocks -->
<p-card class="rounded-2xl shadow-md p-4 bg-white text-gray-800 mb-6 search-section">
    <div class="flex items-center gap-3 mb-4">
        <i class="pi pi-search text-white text-xl"></i>
        <h3 class="text-xl font-semibold text-white mb-0">Search Stocks by Store Location</h3>
    </div>
    
    <div class="flex flex-col md:flex-row items-center gap-4">
        <!-- Search Input -->
        <div class="w-full md:w-2/3">
            <p-floatLabel>
                <input id="searchLocation" 
                    type="text" 
                    pInputText 
                    [(ngModel)]="searchKeyword" 
                    (keyup.enter)="searchStocksByLocation()"
                    [disabled]="isLoadingStocks"
                    autocomplete="off"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-gray-800" />
                <label for="searchLocation" class="text-white">Store Location</label>
            </p-floatLabel>
        </div>

        <!-- Search Button -->
        <p-button label="Search Stocks" 
                icon="pi pi-search" 
                (click)="searchStocksByLocation()"
                [disabled]="!searchKeyword.trim() || isLoadingStocks"
                [loading]="isLoadingStocks"
                class="p-button-primary"></p-button>
        
        <!-- Hide Stocks Button -->
        <p-button *ngIf="showStocks" 
                label="Hide Stocks" 
                icon="pi pi-times" 
                (click)="hideStocks()"
                class="p-button-secondary"></p-button>
    </div>
</p-card>

<!-- Stock Results -->
<p-card *ngIf="showStocks" class="rounded-2xl shadow-md p-4 bg-white text-gray-800 mb-6 stock-results">
    <div class="flex justify-between items-center mb-4">
        <div class="flex items-center gap-3">
            <i class="pi pi-box text-blue-600 text-xl"></i>
            <h3 class="text-xl font-semibold text-gray-700 mb-0">
                Stocks for Location: "{{ searchedLocation }}"
            </h3>
        </div>
        <div class="flex items-center gap-2">
            <span class="text-sm text-gray-500">{{ stocks.length }} item(s) found</span>
            <span *ngIf="isLoadingStocks" class="pi pi-spin pi-spinner text-blue-600"></span>
        </div>
    </div>
    
    <p-table [value]="stocks" 
            [tableStyle]="{ 'min-width': '100%' }"
            [loading]="isLoadingStocks"
            class="shadow-sm rounded-md border border-gray-200 bg-white">
        <ng-template pTemplate="header">
            <tr class="bg-gray-100 text-sm">
                <th class="px-4 py-2">Stock ID</th>
                <th class="px-4 py-2">Store ID</th>
                <th class="px-4 py-2">Product ID</th>
                <th class="px-4 py-2">Quantity</th>
                <th class="px-4 py-2">Status</th>
                <th class="px-4 py-2">Actions</th>
            </tr>
        </ng-template>

        <ng-template pTemplate="body" let-stock>
            <tr class="hover:bg-gray-50 text-gray-800">
                <td class="px-4 py-2 font-medium">
                    <span class="font-mono text-sm">{{ stock.id }}</span>
                </td>
                <td class="px-4 py-2">
                    <span class="font-mono text-sm">{{ stock.storeId }}</span>
                </td>
                <td class="px-4 py-2">
                    <span class="font-mono text-sm">{{ stock.productId }}</span>
                </td>
                <td class="px-4 py-2">
                    <span [class]="stock.quantity > 0 ? 'quantity-positive' : 'quantity-zero'">
                        {{ stock.quantity }}
                    </span>
                </td>
                <td class="px-4 py-2">
                    <span [class]="getStockStatusClass(stock.quantity)">
                        {{ getStockStatus(stock.quantity) }}
                    </span>
                </td>
                <td class="px-4 py-2">
                    <p-button icon="pi pi-history" 
                            [text]="true" 
                            size="small"
                            (click)="viewStockHistory(stock)"
                            pTooltip="View stock history"
                            tooltipPosition="top"
                            class="p-button-primary"></p-button>
                </td>
            </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="6" class="text-center text-gray-400 py-8">
                    <div class="flex flex-col items-center gap-2">
                        <i class="pi pi-inbox text-4xl text-gray-300"></i>
                        <span class="text-lg">No stocks found for this location</span>
                        <span class="text-sm text-gray-400">Try searching for a different store location</span>
                    </div>
                </td>
            </tr>
        </ng-template>
    </p-table>
</p-card>

<!-- Stock History Results -->
<p-card *ngIf="showStockHistory" class="rounded-2xl shadow-md p-4 bg-white text-gray-800 mb-6 stock-results">
    <div class="flex justify-between items-center mb-4">
        <div class="flex items-center gap-3">
            <i class="pi pi-history text-purple-600 text-xl"></i>
            <h3 class="text-xl font-semibold text-gray-700 mb-0">
                Stock History for Product: {{ selectedStock?.productId }}
            </h3>
        </div>
        <div class="flex items-center gap-2">
            <span class="text-sm text-gray-500">{{ stockHistory.length }} record(s) found</span>
            <span *ngIf="isLoadingHistory" class="pi pi-spin pi-spinner text-purple-600"></span>
            <p-button icon="pi pi-times" 
                    [text]="true" 
                    size="small"
                    (click)="hideStockHistory()"
                    pTooltip="Close history"
                    tooltipPosition="top"
                    class="p-button-secondary"></p-button>
        </div>
    </div>
    
    <p-table [value]="stockHistory" 
            [tableStyle]="{ 'min-width': '100%' }"
            [loading]="isLoadingHistory"
            class="shadow-sm rounded-md border border-gray-200 bg-white">
        <ng-template pTemplate="header">
            <tr class="bg-purple-100 text-sm">
                <th class="px-4 py-2">Date & Time</th>
                <th class="px-4 py-2">Quantity Change</th>
                <th class="px-4 py-2">Reason</th>
                <th class="px-4 py-2">Store ID</th>
            </tr>
        </ng-template>

        <ng-template pTemplate="body" let-history>
            <tr class="hover:bg-gray-50 text-gray-800">
                <td class="px-4 py-2">
                    <div class="flex items-center gap-2">
                        <i class="pi pi-calendar text-gray-400"></i>
                        <span class="text-sm">{{ formatDateTime(history.timestamp) }}</span>
                    </div>
                </td>
                <td class="px-4 py-2">
                    <div class="flex items-center gap-2">
                        <i [class]="getQuantityChangeIcon(history.quantityChange)" 
                        [class.text-green-600]="history.quantityChange > 0"
                        [class.text-red-600]="history.quantityChange < 0"
                        [class.text-gray-600]="history.quantityChange === 0"></i>
                        <span [class]="getQuantityChangeClass(history.quantityChange)">
                            {{ history.quantityChange > 0 ? '+' : '' }}{{ history.quantityChange }}
                        </span>
                    </div>
                </td>
                <td class="px-4 py-2">
                    <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-medium">
                        {{ history.reason || 'No reason provided' }}
                    </span>
                </td>
                <td class="px-4 py-2">
                    <span class="font-mono text-sm text-gray-600">{{ history.storeId }}</span>
                </td>
            </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="4" class="text-center text-gray-400 py-8">
                    <div class="flex flex-col items-center gap-2">
                        <i class="pi pi-history text-4xl text-gray-300"></i>
                        <span class="text-lg">No history records found</span>
                        <span class="text-sm text-gray-400">This stock item has no recorded changes</span>
                    </div>
                </td>
            </tr>
        </ng-template>
    </p-table>
</p-card>

<!-- Stores Table -->
<p-card class="rounded-2xl shadow-md p-4 bg-white text-gray-800">
    <div class="flex items-center gap-3 mb-4">
        <i class="pi pi-building text-blue-600 text-xl"></i>
        <h3 class="text-xl font-semibold text-gray-700 mb-0">All Stores</h3>
        <span *ngIf="isLoadingStores" class="pi pi-spin pi-spinner text-blue-600"></span>
    </div>
    
    <!-- Table -->
    <p-table [value]="stores" 
            [tableStyle]="{ 'min-width': '100%' }"
            [loading]="isLoadingStores"
            class="shadow-sm rounded-md border border-gray-200 bg-white text-gray-800">
        <ng-template pTemplate="header">
            <tr class="bg-gray-100 text-sm">
                <th class="px-4 py-2">ID</th>
                <th class="px-4 py-2">Location</th>
                <th class="px-4 py-2">Actions</th>
            </tr>
        </ng-template>

        <ng-template pTemplate="body" let-store>
            <tr class="hover:bg-gray-50 text-gray-800">
                <td class="px-4 py-2 font-medium">
                    <span class="font-mono text-sm">{{ store.id }}</span>
                </td>
                <td class="px-4 py-2 font-semibold">{{ store.location }}</td>
                <td class="px-4 py-2">
                    <p-button icon="pi pi-search" 
                            [text]="true" 
                            size="small"
                            (click)="searchKeyword = store.location; searchStocksByLocation()"
                            pTooltip="View stocks for this store"
                            tooltipPosition="top"></p-button>
                </td>
            </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="3" class="text-center text-gray-400 py-8">
                    <div class="flex flex-col items-center gap-2">
                        <i class="pi pi-building text-4xl text-gray-300"></i>
                        <span class="text-lg">No stores found</span>
                        <span class="text-sm text-gray-400">Create your first store below</span>
                    </div>
                </td>
            </tr>
        </ng-template>
    </p-table>

    <!-- Create Store Form -->
    <div class="mt-6 border-t pt-6">
        <div class="flex items-center gap-3 mb-4">
            <i class="pi pi-plus-circle text-green-600 text-xl"></i>
            <h3 class="text-xl font-semibold text-gray-700 mb-0">Add New Store</h3>
        </div>

        <div class="flex flex-col md:flex-row items-center gap-4">
            <!-- Location Input -->
            <div class="w-full md:w-2/3">
                <p-floatLabel>
                    <input id="location" 
                        type="text" 
                        pInputText 
                        [(ngModel)]="newStore.location" 
                        [disabled]="isCreatingStore"
                        autocomplete="off"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-gray-800" />
                    <label for="location">Store Location</label>
                </p-floatLabel>
            </div>

            <!-- Submit Button -->
            <p-button label="Create Store" 
                    icon="pi pi-plus" 
                    (click)="createStore()"
                    [disabled]="!newStore.location.trim() || isCreatingStore"
                    [loading]="isCreatingStore"
                    class="p-button-success"></p-button>
        </div>
    </div>
</p-card>